<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Advanced Scripting Guide - Brigade</title>
<meta name="description" content="This guide provides some tips and ideas for advanced scripting.">
<meta name="generator" content="Hugo 0.54.0" />
<link href="/index.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="/topics/scripting_advanced/">
<link rel="stylesheet" href="/css/theme.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="/js/functions.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<script src="/js/jquery.backtothetop/jquery.backtothetop.min.js"></script></head>
<body>
<div class="container"><header>
<h1>Brigade</h1>

<p class="description">Brigade - Event-driven scripting for Kubernetes.</p>
<div class="menu">
<nav>
<ul>
<li><a href="https://docs.brigade.sh">Docs</a></li>
<li><a href="https://github.com/Azure/brigade/tree/master/docs/content/examples">Examples</a></li>
<li><a href="https://github.com/azure/brigade">Github</a></li></ul>
</nav>
</div>
</header>
<div class="content-container">
<main>
  <article class="content-wrap"><h1>Advanced Scripting Guide</h1>

<h1 id="advanced-scripting-guide">Advanced Scripting Guide</h1>

<p>This guide provides some tips and ideas for advanced scripting. It assumes that
you are familiar with <a href="scripting.md">the scripting guide</a> and the
<a href="javascript.md">JavaScript API</a>.</p>

<h2 id="using-async-and-await-to-run-jobs">Using <code>async</code> and <code>await</code> to run Jobs</h2>

<p>Recent versions of JavaScript added a new way of declaring asynchronous methods, and then calling them. This way is compatible with promises. Brigade supports the new <code>async</code> and <code>await</code> decorators.</p>

<p>Here&rsquo;s a simple <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise chain</a> that calls two jobs:</p>

<pre><code class="language-javascript">const { events, Job } = require(&quot;brigadier&quot;);

events.on(&quot;exec&quot;, exec);

function exec(e, p) {
    let j1 = new Job(&quot;j1&quot;, &quot;alpine:3.7&quot;, [&quot;echo hello&quot;]);
    let j2 = new Job(&quot;j2&quot;, &quot;alpine:3.7&quot;, [&quot;echo goodbye&quot;]);

    j1.run()
    .then(() =&gt; {
        return j2.run()
    })
    .then(() =&gt; {
        console.log(&quot;done&quot;);
    });
};
</code></pre>

<p><a href="examples/advanced-01.js">advanced-01.js</a></p>

<p>In the example above, we use implicit JavaScript <code>Promise</code> objects for chaining two jobs, then printing <code>done</code> after the two jobs are run. Each <code>Job.run()</code> call returns a <code>Promise</code>, and we call that <code>Promise</code>&rsquo;s <code>then()</code> method.</p>

<p>We can rewrite this to use <code>await</code> and get the same result:</p>

<pre><code class="language-javascript">const { events, Job } = require(&quot;brigadier&quot;);

events.on(&quot;exec&quot;, exec);

async function exec(e, p) {
    let j1 = new Job(&quot;j1&quot;, &quot;alpine:3.7&quot;, [&quot;echo hello&quot;]);
    let j2 = new Job(&quot;j2&quot;, &quot;alpine:3.7&quot;, [&quot;echo goodbye&quot;]);

    await j1.run();
    await j2.run();
    console.log(&quot;done&quot;);
}
</code></pre>

<p><a href="examples/advanced-02.js">advanced-02.js</a></p>

<p>The first thing to note about this example is that we are annotating our <code>exec()</code> function with the <code>async</code> prefix. This tells the JavaScript runtime that the function is an asynchronous handler.</p>

<p>The two <code>await</code> statements will cause the job runs to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await">run synchronously</a>. The first job will run to completion, then the second job will run to completion. Then the <code>console.log</code> function will execute.</p>

<p>Note that when errors occur, they are thrown as exceptions. To handle this case, use <code>try</code>/<code>catch</code> blocks:</p>

<pre><code class="language-javascript">const { events, Job } = require(&quot;brigadier&quot;);

events.on(&quot;exec&quot;, exec);

async function exec(e, p) {
    let j1 = new Job(&quot;j1&quot;, &quot;alpine:3.7&quot;, [&quot;echo hello&quot;]);
    // This will fail
    let j2 = new Job(&quot;j2&quot;, &quot;alpine:3.7&quot;, [&quot;exit 1&quot;]);

    try {
        await j1.run();
        await j2.run();
        console.log(&quot;done&quot;);
    } catch (e) {
        console.log(`Caught Exception ${e}`);
    } 
};
</code></pre>

<p><a href="examples/advanced-03.js">advanced-03.js</a></p>

<p>In the example above, the second job (<code>j2</code>) will execute <code>exit 1</code>, which will cause the container to exit with an error. When <code>await j2.run()</code> is executed, it will throw an exception because <code>j2</code> exited with an error. In our <code>catch</code> block, we print the error message that we receive.</p>

<p>If we run this, we&rsquo;ll see something like this:</p>

<pre><code class="language-console">$ brig run -f advanced-03.js deis/empty-testbed
Event created. Waiting for worker pod named &quot;brigade-worker-01ckcc06200kqdvkdp3nc65bap&quot;.
Build: 01ckcc06200kqdvkdp3nc65bap, Worker: brigade-worker-01ckcc06200kqdvkdp3nc65bap
prestart: no dependencies file found
prestart: src/brigade.js written
[brigade] brigade-worker version: 0.15.0
[brigade:k8s] Creating PVC named brigade-worker-01ckcc06200kqdvkdp3nc65bap
// Omitted status messages
[brigade:k8s] brigade/j2-01ckcc06200kqdvkdp3nc65bap phase Failed
  Error: Pod j2-01ckcc06200kqdvkdp3nc65bap failed to run to completion

  - k8s.js:417 k.readNamespacedPod.then.response
    ./dist/k8s.js:417:32


Caught Exception Error: job j2(j2-01ckcc06200kqdvkdp3nc65bap): Error: Pod j2-01ckcc06200kqdvkdp3nc65bap failed to run to completion

[brigade:app] after: default event handler fired
[brigade:app] beforeExit(2): destroying storage
[brigade:k8s] Destroying PVC named brigade-worker-01ckcc06200kqdvkdp3nc65bap
</code></pre>

<p>The line <code>Caught Exception...</code> shows the error that we received.</p>

<p>Some people feel that using <code>async</code>/<code>await</code> makes code more readable. Others prefer the <code>Promise</code> notation. Brigade will support either. The pattern above can be used with <code>Group</code> and other <code>Promise</code>-aware Brigade objects as well.</p>

<h2 id="using-object-oriented-javascript-to-extend-job">Using Object-oriented JavaScript to Extend <code>Job</code></h2>

<p>JavaScript supports class-based object oriented programming. And Brigade, written in TypeScript, provides some useful ways of working with the <code>Job</code> class. The <code>Job</code> class can be extended to either preconfigure similar jobs or to add extra functionality to a job.</p>

<p>The following example creates a <code>MyJob</code> class that extends <code>Job</code> and provides some predefined
fields:</p>

<pre><code class="language-javascript">const {events, Job, Group} = require(&quot;brigadier&quot;);

class MyJob extends Job {
  constructor(name) {
    super(name, &quot;alpine:3.7&quot;);
    this.tasks = [
      &quot;echo hello&quot;,
      &quot;echo world&quot;
    ];
  }
}

events.on(&quot;exec&quot;, (e, p) =&gt; {
  const j1 = new MyJob(&quot;j1&quot;)
  const j2 = new MyJob(&quot;j2&quot;)

  Group.runEach([j1, j2])
});
</code></pre>

<p><a href="examples/advanced-04.js">advanced-04.js</a></p>

<p>In the example above, both <code>j1</code> and <code>j2</code> will have the same image and the same tasks. They inherited these predefined settings from the <code>MyJob</code> class. Using inheritence in this way can reduce boilerplate code.</p>

<p>The fields can be selectively overwritten, as well. So we could, for example, add another task to the first job without impacting the second job:</p>

<pre><code class="language-javascript">const {events, Job, Group} = require(&quot;brigadier&quot;);

class MyJob extends Job {
  constructor(name) {
    super(name, &quot;alpine:3.7&quot;);
    this.tasks = [
      &quot;echo hello&quot;,
      &quot;echo world&quot;
    ];
  }
}

events.on(&quot;exec&quot;, (e, p) =&gt; {
  const j1 = new MyJob(&quot;j1&quot;)
  j1.tasks.push(&quot;echo goodbye&quot;);
  
  const j2 = new MyJob(&quot;j2&quot;)

  Group.runEach([j1, j2])
});
</code></pre>

<p><a href="examples/advanced-05.js">advanced-05.js</a></p>

<p>If we were to look at the output of these two jobs, we&rsquo;d see something like this:</p>

<pre><code class="language-console">$ brig build logs --last --jobs
# ...
==========[  j1-01ckccs3vs14qzjma4z1zyrjas  ]==========
hello
world
goodbye

==========[  j2-01ckccs3vs14qzjma4z1zyrjas  ]==========
hello
world
</code></pre>

<p>Job <code>j1</code> has our extra command, while <code>j2</code> only inherited the defaults from <code>MyJob</code>.</p>

<hr />

<p>Prev: <a href="javascript.md">Brigade.js Reference</a> <code>|</code> Next: <a href="github.md">GitHub Integration</a></p>

<p>Return to the <a href="index.md">Table of Contents</a></p>
<div class="edit-meta">
<br></div><nav class="pagination"><a class="nav nav-prev" href="/topics/" title="Topic Guides"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - Topic Guides</a>
<a class="nav nav-next" href="/topics/dockerhub/" title="Container Registry Integration">Next - Container Registry Integration <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav></article>
<footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://themes.gohugo.io/hugo-theme-techdoc/">TechDoc</a>. Designed by <a href="https://github.com/thingsym/hugo-theme-techdoc">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">
<nav>
<ul>
<li class=""><a href="/">Home</a></li>

<li class=""><a href="/intro/">Getting Started</a>
<ul class="">
<li class=""><a href="/intro/overview/">Brigade Overview</a></li>
<li class=""><a href="/intro/install/">Installing Brigade</a></li>
<li class=""><a href="/intro/tutorial01/">Tutorial 1: Writing a CI pipeline</a></li>
<li class=""><a href="/intro/tutorial02/">Tutorial 2: Setup GitHub</a></li>
<li class=""><a href="/intro/tutorial03/">Tutorial 3: Projects &amp; Events</a></li>
<li class=""><a href="/intro/tutorial04/">Tutorial 4: Writing a Test</a></li>
<li class=""><a href="/intro/writing-efficient-pipelines/">Tutorial 5: Writing Efficient Pipelines</a></li>
<li class=""><a href="/intro/readnext/">What to Read Next</a></li>
</ul>
  
</li>

<li class="parent"><a href="/topics/">Topic Guides</a>
<ul class="sub-menu">
<li class="active"><a href="/topics/scripting_advanced/">Advanced Scripting Guide</a></li>
<li class=""><a href="/topics/dockerhub/">Container Registry Integration</a></li>
<li class=""><a href="/topics/dependencies/">Dependencies</a></li>
<li class=""><a href="/topics/design/">Design</a></li>
<li class=""><a href="/topics/developers/">Developer Guide</a></li>
<li class=""><a href="/topics/gateways/">Gateways</a></li>
<li class=""><a href="/topics/genericgateway/">Generic Gateway</a></li>
<li class=""><a href="/topics/github/">GitHub Integration</a></li>
<li class=""><a href="/topics/ingress/">Ingress</a></li>
<li class=""><a href="/topics/projects/">Managing Projects in Brigade</a></li>
<li class=""><a href="/topics/releasing/">Releasing Brigade</a></li>
<li class=""><a href="/topics/scripting/">Scripting Guide</a></li>
<li class=""><a href="/topics/secrets/">Secret Management</a></li>
<li class=""><a href="/topics/security/">Securing Brigade</a></li>
<li class=""><a href="/topics/storage/">Storage</a></li>
<li class=""><a href="/topics/testing/">Testing</a></li>
<li class=""><a href="/topics/javascript/">The Brigade.js API</a></li>
<li class=""><a href="/topics/workers/">Workers</a></li>
</ul>
  
</li>
</ul>
</nav>


<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>
