<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Developer Guide - Brigade</title>
<meta name="description" content="How to get started developing Brigad">
<meta name="generator" content="Hugo 0.54.0" />
<link href="/index.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="/topics/developers/">
<link rel="stylesheet" href="/css/theme.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="/js/functions.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<script src="/js/jquery.backtothetop/jquery.backtothetop.min.js"></script></head>
<body>
<div class="container"><header>
<h1>Brigade</h1>

<p class="description">Brigade - Event-driven scripting for Kubernetes.</p>
<div class="menu">
<nav>
<ul>
<li><a href="https://docs.brigade.sh">Docs</a></li>
<li><a href="https://github.com/Azure/brigade/tree/master/docs/content/examples">Examples</a></li>
<li><a href="https://github.com/azure/brigade">Github</a></li></ul>
</nav>
</div>
</header>
<div class="content-container">
<main>
  <article class="content-wrap"><h1>Developer Guide</h1>

<h1 id="developer-guide">Developer Guide</h1>

<p>This document explains how to get started developing Brigade.</p>

<p>Brigade is composed of numerous parts.  The following represent the core components:</p>

<ul>
<li>brigade-controller: The Kubernetes controller for delegating Brigade events</li>
<li>brigade-worker: The JavaScript runtime for executing <code>brigade.js</code> files. The
controller spawns these, though you can run one directly as well.</li>
<li>brigade-api: The REST API server for user interfaces</li>
<li>brigade-project: The Helm <a href="https://github.com/Azure/brigade-charts/tree/master/charts/brigade-project">chart</a> for installing Brigade projects</li>
<li>brigade-vacuum: The stale build cleaner-upper (optional; enabled by default)</li>
<li>brig: The Brigade CLI</li>
<li>git-sidecar: The code that runs as a sidecar in cluster to fetch Git repositories (optional; enabled by default)</li>
</ul>

<p>Additionally, there are several opt-in gateways that can be enabled via Helm chart values.  These are:</p>

<ul>
<li>Brigade GitHub App Gateway: The implementation of the GitHub App web hooks. It requires
the controller.</li>
<li>Generic Gateway: A generic gateway offering flexibility to create Brigade events from webhooks
originating from an arbitrary service/platform.</li>
<li>Container Registry Gateway: A gateway supporting container registry webhooks such as the ones emitted by
DockerHub and ACR.</li>
</ul>

<p>Read up on all the gateways above, as well as others, in the <a href="./gateways.md">Gateways doc</a>.</p>

<p>This document covers environment setup, how to run functional tests and development of
<code>brigade-controller</code> and <code>brigade-worker</code> components.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
<li>Go toolchain (latest version)</li>
<li>Minikube</li>
<li>Docker</li>
<li>make</li>
<li>Node.js, Yarn and NPM</li>
</ul>

<h2 id="clone-the-repository-in-gopath">Clone the Repository In GOPATH</h2>

<p>Follow these steps when cloning the brigade repository to use an existing <code>GOPATH</code> for your system:</p>

<pre><code class="language-bash">export GOPATH=$(go env GOPATH) # GOPATH is set to $HOME/go by default
export PATH=$GOPATH/bin:$PATH # 'make bootstrap brig' will try to execute binnaries in $GOPATH/bin
mkdir -p $GOPATH/src/github.com/Azure
git clone https://github.com/Azure/brigade $GOPATH/src/github.com/Azure/brigade
cd $GOPATH/src/github.com/Azure/brigade
</code></pre>

<p><strong>Note</strong>: this leaves you at the tip of <strong>master</strong> in the repository where active development
is happening. You might prefer to checkout the most recent stable tag:</p>

<ul>
<li><code>$ git checkout v0.20.0</code></li>
</ul>

<p>After cloning the project locally, you should run this command to <a href="https://help.github.com/articles/configuring-a-remote-for-a-fork/">configure the remote</a>:</p>

<pre><code class="language-bash">git remote add fork https://github.com/&lt;your GitHub username&gt;/brigade
</code></pre>

<p>To push your changes to your fork, run:</p>

<pre><code class="language-bash">git push --set-upstream fork &lt;branch&gt;
</code></pre>

<h2 id="building-source">Building Source</h2>

<p>To build all of the source, run this:</p>

<pre><code>$ make bootstrap build
</code></pre>

<p>To build just the client binaries, run this:</p>

<pre><code>$ make bootstrap brig
</code></pre>

<p>To build Docker images, run:</p>

<pre><code>$ make docker-build
</code></pre>

<h2 id="javascript-bootstrap-test">Javascript Bootstrap/Test</h2>

<p>To bootstrap the Javascript dependencies required by Brigade Worker:</p>

<pre><code>$ make bootstrap-js
</code></pre>

<p>To format the Javascript files:</p>

<pre><code>$ make format-js
</code></pre>

<p>To run the tests:</p>

<pre><code>$ make test-js
</code></pre>

<p>(See <code>Running the Brigade-Worker Locally</code> below for live testing against a running instance.)</p>

<h2 id="minikube-configuration">Minikube configuration</h2>

<p>Start Minikube. Your addons should look like this:</p>

<pre><code>$  minikube addons list
- addon-manager: enabled
- dashboard: disabled
- default-storageclass: enabled
- heapster: disabled
- ingress: enabled
- kube-dns: enabled
- registry: disabled
- registry-creds: disabled
</code></pre>

<p>Feel free to enable other addons, but the ones above are expected to be present
for Brigade to operate.</p>

<p>For local development, you will want to point your Docker client to the Minikube
Docker daemon:</p>

<pre><code>$ eval $(minikube docker-env)
</code></pre>

<p>Running <code>make docker-build</code> will push the Brigade images to the Minikube Docker
daemon. The image tag (set by <code>VERSION</code> in the <a href="../../Makefile">Makefile</a>) will default
to a unique value such as <code>v0.20.0-80-g6721dd8</code>.  You can verify this by running <code>docker images</code>
and affirming these tagged images are listed.</p>

<p>Brigade charts are hosted in the separate <a href="https://github.com/Azure/brigade-charts">Azure/brigade-charts</a>
repo, so we&rsquo;ll need to add the corresponding Helm repo locally:</p>

<pre><code>$ helm repo add brigade https://azure.github.io/brigade-charts
&quot;brigade&quot; has been added to your repositories
</code></pre>

<p>If you just want to roll with the default chart values and let the Makefile set
the image tags appropriately, simply run:</p>

<pre><code class="language-console">$ make helm-install
</code></pre>

<p>This will issue the appropriate command to create a new Brigade chart release on this cluster.</p>

<p>(Note: <code>helm init</code> may be needed to get tiller up and running on the cluster, if not already started.)</p>

<p>During active development, the flow might then look like:</p>

<pre><code class="language-console">$ # make code changes, commit
$ make docker-build
$ make helm-upgrade
$ # (repeat)
$ # push to fork and create pull request
</code></pre>

<p>For finer-grained control, you may wish to create a custom <code>values.yaml</code> file for the chart
and set various values in addition to the latest image tags:</p>

<pre><code>$ helm inspect values brigade/brigade &gt; myvalues.yaml
$ open myvalues.yaml    # Change all `tag:` fields to be `tag: &lt;tag&gt;`, etc.
</code></pre>

<p>From here, you can install Brigade into Minikube using the Helm chart:</p>

<pre><code>$ helm install -n brigade brigade/brigade -f myvalues.yaml
</code></pre>

<p>Don&rsquo;t forget to also create a project.  Check out <a href="./projects.md">projects</a> to see how it&rsquo;s done.</p>

<h2 id="running-brigade-inside-remote-kubernetes">Running Brigade inside remote Kubernetes</h2>

<p>Some developers use a remote Kubernetes instead of minikube.</p>

<p>To run a development version of Brigade inside of a remote Kubernetes,
you will need to do two things:</p>

<ul>
<li>Make sure you push your <code>brigade</code> docker images to a registry the cluster can access</li>
<li>Set the image when you do a <code>helm install brigade/&lt;chart&gt;</code> on the Brigade chart.</li>
</ul>

<h2 id="running-brigade-brigade-controller-locally-against-minikube">Running Brigade (brigade-controller) Locally (against Minikube)</h2>

<p>Assuming you have Brigade installed (either on minikube or another cluster) and
your <code>$KUBECONFIG</code> is pointing to that cluster, you can run <code>brigade-controller</code>
locally.</p>

<pre><code>$ ./bin/brigade-controller --kubeconfig $KUBECONFIG
</code></pre>

<p>(The default location for <code>$KUBECONFIG</code> on UNIX-like systems is <code>$HOME/.kube</code>.)</p>

<p>For the remainder of this document, we will assume that your local <code>$KUBECONFIG</code>
is pointing to the correct cluster.</p>

<h3 id="running-the-functional-tests">Running the Functional Tests</h3>

<p>Once you have Brigade running in Minikube or a comparable alternative, you should be
able to run the functional tests.</p>

<p>First, create a project that points to the <code>deis/empty-testbed</code> project. The most
flexible way of doing this is via the <code>brig</code> cli.  Here we supply <code>-x</code> to forgo
interactive prompts.  All the defaults will therefore be set to the
<a href="https://github.com/deis/empty-testbed">deis/empty-testbed</a> project.</p>

<pre><code class="language-console"> $ brig project create -x
Project ID: brigade-830c16d4aaf6f5490937ad719afd8490a5bcbef064d397411043ac
</code></pre>

<p>You can check this project configuration out via <code>brig project get deis/empty-testbed</code>.</p>

<p>With this setup, you should be able to run <code>make test-functional</code> and see the
tests run against your local Brigade binary.</p>

<h2 id="running-the-brigade-worker-locally">Running the Brigade-Worker Locally</h2>

<p>You can run the Brigade worker locally by <code>cd</code>ing into <code>brigade-worker</code> and running
<code>k brigade</code>. Note that this will require you to set a number of environment
variables. See <code>brigade-worker/index.ts</code> for the list of variables you will need
to set.</p>

<p>Here is an example script for running a quick test against a locally running brigade worker.</p>

<pre><code>#!/bin/bash

export BRIGADE_EVENT_TYPE=quicktest
export BRIGADE_EVENT_PROVIDER=script
export BRIGADE_COMMIT_REF=master
export BRIGADE_PAYLOAD='{}'
export BRIGADE_PROJECT_ID=brigade-830c16d4aaf6f5490937ad719afd8490a5bcbef064d397411043ac
export BRIGADE_PROJECT_NAMESPACE=default
export BRIGADE_SCRIPT=&quot;$(pwd)/brigade.js&quot;

cd ./brigade-worker
echo &quot;running $BRIGADE_EVENT_TYPE on $BRIGADE_SCRIPT for $BRIGADE_PROJECT_ID&quot;
yarn start
</code></pre>

<p>You may change the variables above to point to the desired project.</p>

<hr />

<p>Prev: <a href="workers.md">Workers</a> <code>|</code> Next: <a href="../index.md#technical">Example Projects</a></p>

<p>Return to the <a href="index.md">Table of Contents</a></p>
<div class="edit-meta">
<br></div><nav class="pagination"><a class="nav nav-prev" href="/topics/design/" title="Design"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - Design</a>
<a class="nav nav-next" href="/topics/gateways/" title="Gateways">Next - Gateways <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav></article>
<footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://themes.gohugo.io/hugo-theme-techdoc/">TechDoc</a>. Designed by <a href="https://github.com/thingsym/hugo-theme-techdoc">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">
<nav>
<ul>
<li class=""><a href="/">Home</a></li>

<li class=""><a href="/intro/">Getting Started</a>
<ul class="">
<li class=""><a href="/intro/overview/">Brigade Overview</a></li>
<li class=""><a href="/intro/install/">Installing Brigade</a></li>
<li class=""><a href="/intro/tutorial01/">Tutorial 1: Writing a CI pipeline</a></li>
<li class=""><a href="/intro/tutorial02/">Tutorial 2: Setup GitHub</a></li>
<li class=""><a href="/intro/tutorial03/">Tutorial 3: Projects &amp; Events</a></li>
<li class=""><a href="/intro/tutorial04/">Tutorial 4: Writing a Test</a></li>
<li class=""><a href="/intro/writing-efficient-pipelines/">Tutorial 5: Writing Efficient Pipelines</a></li>
<li class=""><a href="/intro/readnext/">What to Read Next</a></li>
</ul>
  
</li>

<li class="parent"><a href="/topics/">Topic Guides</a>
<ul class="sub-menu">
<li class=""><a href="/topics/scripting_advanced/">Advanced Scripting Guide</a></li>
<li class=""><a href="/topics/dockerhub/">Container Registry Integration</a></li>
<li class=""><a href="/topics/dependencies/">Dependencies</a></li>
<li class=""><a href="/topics/design/">Design</a></li>
<li class="active"><a href="/topics/developers/">Developer Guide</a></li>
<li class=""><a href="/topics/gateways/">Gateways</a></li>
<li class=""><a href="/topics/genericgateway/">Generic Gateway</a></li>
<li class=""><a href="/topics/github/">GitHub Integration</a></li>
<li class=""><a href="/topics/ingress/">Ingress</a></li>
<li class=""><a href="/topics/projects/">Managing Projects in Brigade</a></li>
<li class=""><a href="/topics/releasing/">Releasing Brigade</a></li>
<li class=""><a href="/topics/scripting/">Scripting Guide</a></li>
<li class=""><a href="/topics/secrets/">Secret Management</a></li>
<li class=""><a href="/topics/security/">Securing Brigade</a></li>
<li class=""><a href="/topics/storage/">Storage</a></li>
<li class=""><a href="/topics/testing/">Testing</a></li>
<li class=""><a href="/topics/javascript/">The Brigade.js API</a></li>
<li class=""><a href="/topics/workers/">Workers</a></li>
</ul>
  
</li>
</ul>
</nav>


<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>
