<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Container Registry Integration - Brigade</title>
<meta name="description" content="How to use Brigade with DockerHub, ACR, etc">
<meta name="generator" content="Hugo 0.54.0" />
<link href="/index.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="/topics/dockerhub/">
<link rel="stylesheet" href="/css/theme.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="/js/functions.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<script src="/js/jquery.backtothetop/jquery.backtothetop.min.js"></script></head>
<body>
<div class="container"><header>
<h1>Brigade</h1>

<p class="description">Brigade - Event-driven scripting for Kubernetes.</p>
<div class="menu">
<nav>
<ul>
<li><a href="https://docs.brigade.sh">Docs</a></li>
<li><a href="https://github.com/Azure/brigade/tree/master/docs/content/examples">Examples</a></li>
<li><a href="https://github.com/azure/brigade">Github</a></li></ul>
</nav>
</div>
</header>
<div class="content-container">
<main>
  <article class="content-wrap"><h1>Container Registry Integration</h1>

<h1 id="container-registry-dockerhub-acr-integration">Container Registry (DockerHub, ACR) Integration</h1>

<p>Brigade supports container registry webhooks such as the ones emitted by
DockerHub and ACR. The following platforms are known to work with
Brigade&rsquo;s Container Registry gateway:</p>

<ul>
<li>DockerHub</li>
<li>Azure Container Registry (ACR) with the <code>Managed_*</code> classes</li>
</ul>

<p>DockerHub/ACR integration is <em>not enabled by default</em>.</p>

<h2 id="intro-to-container-registry-webhook-integration">Intro to Container Registry Webhook Integration</h2>

<p>Brigade comes with built-in support for container registry image pushing events. When a
container registry webhook system is configured to notify Brigade&rsquo;s GW server, Brigade will
respond to an image push by triggering an <code>image_push</code> event.</p>

<p>This provides Brigade developers with the ability to trigger scripts based on a
new image being pushed to a Docker repository.</p>

<h2 id="configuring-brigade">Configuring Brigade</h2>

<p>Container Registry support is disabled by default, but can easily be turned on
during installation or upgrade of Brigade:</p>

<pre><code>$ helm install -n brigade brigade/brigade --set cr.enabled=true
</code></pre>

<p>This will enable the container registry. You will likely also want to expose the
container registry outside of the cluster so that inbound webhooks will work. The
easiest way to do this is to also set up a service of type <code>LoadBalancer</code>:</p>

<pre><code>$ helm install -n brigade brigade/brigade --set cr.enabled=true,cr.service.type=LoadBalancer
</code></pre>

<p>A more secure route is to install an SSL proxy (like <code>kube-lego</code>) and directing
that to the internal container registry service.</p>

<p>For more installation configuration options, run <code>helm inspect values brigade/brigade</code>
and read the <code>cr:</code> section.</p>

<h2 id="configuring-the-repository">Configuring the Repository</h2>

<p>The repository <em>must</em> support web hooks.</p>

<p>The URL pattern for calling a webhook is this:</p>

<pre><code>http://&lt;YOUR GATEWAY&gt;:8000/events/webhook/&lt;YOUR PROJECT NAME&gt;/&lt;COMMIT&gt;
</code></pre>

<p>For example, to connect to the project <code>technosophos/example-hook</code> and use the head
commit, we would use:</p>

<pre><code>http://technosophos.brigade.sh:8000/events/webhook/technosophos/example-hook/master
</code></pre>

<p>For DockerHub, this URL is added in the <code>webhooks</code> tab of the Docker repository for
your image.</p>

<p>For Azure Container Registry, this URL is added on the <code>webhooks</code> tab of your
ACR repository&rsquo;s blade.</p>

<h3 id="alternative-webhook-paths">Alternative Webhook Paths</h3>

<p>In addition to the format above, you may use either of these paths as alternatives.
These may be useful in cases where your project name or commit ID do not
match the path-like assumptions of the above:</p>

<pre><code>http://&lt;YOUR GATEWAY&gt;:8000/events/webhook/&lt;YOUR PROJECT Name&gt;?commit=&lt;COMMIT&gt;
http://&lt;YOUR GATEWAY&gt;:8000/events/webhook/&lt;YOUR PROJECT ID&gt;?commit=&lt;COMMIT&gt;
</code></pre>

<p>So the following URLs are also valid:</p>

<pre><code>http://technosophos.brigade.sh:8000/events/webhook/technosophos/example-hook?commit=master
http://technosophos.brigade.sh:8000/events/webhook/brigade-830c16d4aaf6f5490937ad719afd8490a5bcbef064d397411043ac?commit=master
</code></pre>

<h2 id="configuring-your-brigade-js">Configuring your <code>brigade.js</code></h2>

<p>To answer hooks in your <code>brigade.sh</code>, you will need to do something like this:</p>

<pre><code class="language-javascript">const {events, Job} = require(&quot;brigadier&quot;)

events.on(&quot;image_push&quot;, (e, p) =&gt; {
  var docker = JSON.parse(e.payload)
  console.log(docker)
})
</code></pre>

<p>The webhook data sent by DockerHub is different than the data sent by Azure
Container Registry. The following example uses ACR&rsquo;s <code>action</code> and <code>target</code>
objects:</p>

<pre><code class="language-javascript">const {events, Job} = require(&quot;brigadier&quot;)

events.on(&quot;image_push&quot;, (e, p) =&gt; {
  var docker = JSON.parse(e.payload)

  // Currently the only action sent is 'push', but this makes your script
  // safe for the future.
  if (docker.action != &quot;push&quot;) {
    console.log(`ignoring action ${docker.action}`)
    return
  }

  // Here's how you get the tag.
  var version = docker.target.tag || &quot;latest&quot;
  console.log(`image version: ${version}`)
}
</code></pre>

<p>The above answers an ACR webhook. The data sent by DockerHub&rsquo;s webhook is
<a href="https://docs.docker.com/docker-hub/webhooks/">slightly different</a>.</p>

<p><strong>IMPORTANT:</strong> An event will trigger for <em>every tag you push</em>, even if that tag
is not new or updated. If you push both a <code>latest</code> and a versioned tag for a
single image, you will get two webhook invocations.</p>

<hr />

<p>Prev: <a href="github.md">GitHub Integration</a> <code>|</code> Next: <a href="genericgateway.md">Generic Gateway Integration</a></p>

<p>Return to the <a href="index.md">Table of Contents</a></p>
<div class="edit-meta"><small>Last updated on January 1, 0001 / Published on January 1, 0001</small>
<br></div><nav class="pagination"><a class="nav nav-prev" href="/topics/scripting_advanced/" title="Advanced Scripting Guide"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - Advanced Scripting Guide</a>
<a class="nav nav-next" href="/topics/dependencies/" title="Dependencies">Next - Dependencies <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav></article>
<footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://themes.gohugo.io/hugo-theme-techdoc/">TechDoc</a>. Designed by <a href="https://github.com/thingsym/hugo-theme-techdoc">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">
<nav>
<ul>
<li class=""><a href="/">Home</a></li>

<li class=""><a href="/intro/">Getting Started</a>
<ul class="">
<li class=""><a href="/intro/overview/">Brigade Overview</a></li>
<li class=""><a href="/intro/install/">Installing Brigade</a></li>
<li class=""><a href="/intro/tutorial01/">Tutorial 1: Writing a CI pipeline</a></li>
<li class=""><a href="/intro/tutorial02/">Tutorial 2: Setup GitHub</a></li>
<li class=""><a href="/intro/tutorial03/">Tutorial 3: Projects &amp; Events</a></li>
<li class=""><a href="/intro/tutorial04/">Tutorial 4: Writing a Test</a></li>
<li class=""><a href="/intro/writing-efficient-pipelines/">Tutorial 5: Writing Efficient Pipelines</a></li>
</ul>
  
</li>

<li class="parent"><a href="/topics/">Topic Guides</a>
<ul class="sub-menu">
<li class=""><a href="/topics/scripting_advanced/">Advanced Scripting Guide</a></li>
<li class="active"><a href="/topics/dockerhub/">Container Registry Integration</a></li>
<li class=""><a href="/topics/dependencies/">Dependencies</a></li>
<li class=""><a href="/topics/design/">Design</a></li>
<li class=""><a href="/topics/developers/">Developer Guide</a></li>
<li class=""><a href="/topics/gateways/">Gateways</a></li>
<li class=""><a href="/topics/genericgateway/">Generic Gateway</a></li>
<li class=""><a href="/topics/github/">GitHub Integration</a></li>
<li class=""><a href="/topics/ingress/">Ingress</a></li>
<li class=""><a href="/topics/projects/">Managing Projects in Brigade</a></li>
<li class=""><a href="/topics/releasing/">Releasing Brigade</a></li>
<li class=""><a href="/topics/scripting/">Scripting Guide</a></li>
<li class=""><a href="/topics/secrets/">Secret Management</a></li>
<li class=""><a href="/topics/security/">Securing Brigade</a></li>
<li class=""><a href="/topics/storage/">Storage</a></li>
<li class=""><a href="/topics/testing/">Testing</a></li>
<li class=""><a href="/topics/javascript/">The Brigade.js API</a></li>
<li class=""><a href="/topics/readnext/">What to Read Next</a></li>
<li class=""><a href="/topics/workers/">Workers</a></li>
</ul>
  
</li>
</ul>
</nav>


<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>
