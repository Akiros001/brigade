<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Secret Management - Brigade</title>
<meta name="description" content="How Brigade utilizes Kubernetes secrets.">
<meta name="generator" content="Hugo 0.54.0" />
<link href="/index.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="/topics/secrets/">
<link rel="stylesheet" href="/css/theme.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="/js/functions.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<script src="/js/jquery.backtothetop/jquery.backtothetop.min.js"></script></head>
<body>
<div class="container"><header>
<h1>Brigade</h1>

<p class="description">Brigade - Event-driven scripting for Kubernetes.</p>

</header>

<div class="content-container">
<main><h1>Secret Management</h1>

<h1 id="secret-management">Secret Management</h1>

<p>Brigade provides tools for storing sensitive data outside of your <code>brigade.js</code> scripts,
and then passing that information into the jobs that need them. Brigade accomplishes
this by making use of Kubernetes secrets.</p>

<h2 id="adding-a-secret-to-your-project">Adding a Secret to Your Project</h2>

<p>Imagine a case where we need to pass a sensitive piece of information to one of the jobs
in our <code>brigade.js</code>. For example, we might need to pass an authentication token to a job that
must authenticate to a remote service.</p>

<p>We do this by storing the secret inside of the project definition.</p>

<p>Project definitions are typically managed by <code>brig</code>. As you may recall from the <a href="../intro/install.md">installation
manual</a>, a new project is created like via <code>brig project create</code>.</p>

<p>During the creation process, we are able to add secrets when prompted. If we&rsquo;d forgotten to
add a secret and/or additional secrets need to be added to this existing project, we can do so via
<code>brig project create --replace -p &lt;existing project name&gt;</code>.</p>

<p>Here we add a new secret with key <code>dbPassword</code> and value <code>supersecret</code> to our existing
<code>deis/empty-testbed</code> project:</p>

<pre><code class="language-console">$ brig project create --replace -p deis/empty-testbed
? Existing Project Name deis/empty-testbed
? Full repository name github.com/deis/empty-testbed
? Clone URL (https://github.com/your/repo.git) https://github.com/deis/empty-testbed.git
? Add secrets? Yes
? 	Secret 1 dbPassword
? 	Value supersecret
? ===&gt; Add another? No
Auto-generated a Shared Secret: &quot;9qQvuplBx39r04Wd9EmyxjGA&quot;
? Configure GitHub Access? No
? Configure advanced options No
Project ID: brigade-830c16d4aaf6f5490937ad719afd8490a5bcbef064d397411043ac
</code></pre>

<h2 id="accessing-a-secret-within-brigade-js">Accessing a Secret within <code>brigade.js</code></h2>

<p>Within the <code>brigade.js</code> file, we can access any of the secrets defined on our project.</p>

<pre><code class="language-javascript">// THIS IS NOT SAFE! IT LEAKS YOUR SECRET INTO THE LOGS.
const {events, Job, Group} = require(&quot;brigadier&quot;)

events.on(&quot;push&quot;, function(e, project) {
  console.log(&quot;My DB password is &quot; + project.secrets.dbPassword)
})
</code></pre>

<p>Secrets can be selectively passed to jobs by setting environment variables.</p>

<pre><code class="language-javascript">// THIS IS NOT SAFE! IT LEAKS YOUR SECRET INTO THE LOGS.
const {events, Job, Group} = require(&quot;brigadier&quot;)

events.on(&quot;push&quot;, function(e, project) {
  var j1 = new Job(&quot;secrets&quot;, &quot;alpine:3.4&quot;)

  // Send the password to an environment variable.
  j1.env = {
    &quot;DB_PASSWORD&quot;: project.secrets.dbPassword
  }

  // Print the env var to the log.
  j1.tasks = [
    &quot;echo $DB_PASSWORD&quot;
  ]

  j1.run()
}
</code></pre>

<p>In this case, we retrieve the secret from the project, and we pass it into the new
Job as an environment variable. When the job executes, it can access the <code>dbPassword</code>
as <code>$DB_PASSWORD</code>.</p>

<p>Note that behind the scenes, Brigade is storing the environment variables in another
Job-specific secret.</p>

<h2 id="faq">FAQ</h2>

<p><strong>Why don&rsquo;t all jobs get access to all of the secrets? Why do I have to pass them
to the <code>Job.env</code>?</strong></p>

<p>Brigade is designed to use off-the-shelf Docker images. In the examples above, we used the
<code>alpine:3.4</code> image straight from DockerHub. We wouldn&rsquo;t want to just automatically pass
all of our information straight into that container. For starters, doing so might
inadvertently override an existing environment variable of the same name. More
importantly, the data might get misused or unintentionally exposed by the container.</p>

<p>So we err on the side of safety.</p>

<p><strong>Can I encrypt my secrets?</strong></p>

<p>We use Kubernetes Secrets for holding sensitive data. As encrypted Secrets are
adopted into Kubernetes, we plan to support them. However, the present stable
version of Kubernetes Secrets only Base64-encodes data.</p>

<p>Our present recommendation is for Brigade developers to fetch the secret directly from a
trusted key store such as Vault.  See the <a href="#fetching-secrets-from-a-remote-store">example</a> below.</p>

<p>Alternatively, you could use <code>secretKeyRef</code> to reference existing secrets already in your
Kubernetes cluster.  See the <a href="#using-kubernetes-secrets">example</a> below.</p>

<p><strong>I don&rsquo;t want to use Helm to manage my project/secrets. Can I do it manually?</strong></p>

<p>Yes. Helm is there to make your life easier, but you can manage project secrets manually.
You cannot, however, make manual modifications and then go back to using Helm. Doing so
may result in lost data.</p>

<h2 id="examples">Examples</h2>

<hr />

<h2 id="fetching-secrets-from-a-remote-store">Fetching secrets from a remote store</h2>

<p>Here is an example where we fetch secrets from a remote store
(<a href="https://azure.microsoft.com/en-us/services/key-vault/">Azure Key Vault</a>)
for use by one or more Jobs.</p>

<p>To do so, we first run a Job to authenticate with the remote store, fetch all needed secrets
and save these secret values to a shared directory.  Then, we run a Job that consumes these values.</p>

<p>Here&rsquo;s what our <code>brigade.js</code> file looks like:</p>

<pre><code class="language-javascript">const { events, Job, Group } = require(&quot;brigadier&quot;);

const sharedMountPrefix = `/mnt/brigade/share`;
const secrets = [
  &quot;foo&quot;,
  &quot;bar&quot;
]

events.on(&quot;exec&quot;, (event, project) =&gt; {
  // Create Job to fetch secrets
  secretfetcher = new Job(&quot;secretfetcher&quot;, &quot;microsoft/azure-cli:latest&quot;);
  secretfetcher.storage.enabled = true;

  // Login as an Azure Service Principal
  secretfetcher.tasks.push(
    `az login --service-principal \
    -u ${project.secrets.spID} \
    -p '${project.secrets.spPW}' \
    --tenant ${project.secrets.spTenant}`)

  // Fetch all secrets from the Azure Key Vault
  for (i in secrets) {
    secretfetcher.tasks.push(
      `az keyvault secret show --vault-name ${project.secrets.keyvault} \
      -n ${secrets[i]} --query value &gt; ${sharedMountPrefix}/${secrets[i]}`);
  }

  // Create Job to consume secrets
  secretconsumer = new Job(&quot;secretconsumer&quot;, &quot;alpine&quot;);
  secretconsumer.storage.enabled = true;

  // Consume all secrets
  for (i in secrets) {
    secretconsumer.tasks.push(
      `ls -haltr ${sharedMountPrefix}/${secrets[i]}`);
  }

  // Run jobs sequentially
  Group.runEach([secretfetcher, secretconsumer]);
})
</code></pre>

<p>To run this example, we replace <code>BRIGADE_PROJECT_NAME</code> with our Brigade project name and run:</p>

<pre><code class="language-console">brig run BRIGADE_PROJECT_NAME -f brigade.js
</code></pre>

<p>When we check the logs of the <code>secretconsumer</code> job pod, we see:</p>

<pre><code class="language-console"> $ kubectl logs secretconsumer-01d23ch2n6d1847ys6x48x1rez
-rwxrwxrwx    1 root     root           6 Jan 25 20:52 /mnt/brigade/share/foo
-rwxrwxrwx    1 root     root           6 Jan 25 20:52 /mnt/brigade/share/bar
</code></pre>

<h2 id="using-kubernetes-secrets">Using Kubernetes secrets</h2>

<p>Kubernetes secrets can also be used for consuming secret data.</p>

<p>For this example, we first create the Kubernetes secret:</p>

<pre><code class="language-console">kubectl create secret generic mysecret --from-literal=hello=world
</code></pre>

<p>This Kubernetes Secret has a name of <code>mysecret</code> and a single key-value pair as its data (key: hello, value: world).</p>

<p>Then, we create a <code>brigade.js</code> file with the following contents:</p>

<pre><code class="language-javascript">const { events, Job } = require(&quot;brigadier&quot;);

events.on(&quot;exec&quot;, () =&gt; {
  var job = new Job(&quot;echo&quot;, &quot;alpine&quot;);

  job.env = {
    mySecretReference: {
      secretKeyRef: {
        name: &quot;mysecret&quot;,
        key: &quot;hello&quot;
      }
    }
  };

  job.tasks = [
    &quot;echo hello ${mySecretReference}&quot;
  ];

  job.run();
});
</code></pre>

<p>To recap, <code>mySecretReference</code> is the name of the variable in the job&rsquo;s environment, <code>secretKeyRef.name</code> is the name
of the Kubernetes secret, and <code>secretKeyRef.key</code> is the key pointing to the actual secret value (<code>world</code> in this example.)</p>

<p>As a result, <code>mySecretReference</code> points directly to this secret value in this job&rsquo;s environment.</p>

<p>To run this example, we replace <code>BRIGADE_PROJECT_NAME</code> with our Brigade project name and run:</p>

<pre><code class="language-console">brig run BRIGADE_PROJECT_NAME -f brigade.js
</code></pre>

<p>We will then see <code>&quot;hello world&quot;</code> displayed in the logs.</p>

<hr />

<p>Prev: <a href="genericgateway.md">Generic Gateway Integration</a> <code>|</code> Next: <a href="gateways.md">Brigade Gateways</a></p>

<p>Return to the <a href="index.md">Table of Contents</a></p>
<div class="edit-meta">Last updated on 1 Jan 0001 / Published on 1 Jan 0001<br></div><nav class="pagination"><a class="nav nav-prev" href="/topics/scripting/" title="Scripting Guide"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - Scripting Guide</a>
<a class="nav nav-next" href="/topics/security/" title="Securing Brigade">Next - Securing Brigade <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav><footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://themes.gohugo.io/hugo-theme-techdoc/">TechDoc</a>. Designed by <a href="https://github.com/thingsym/hugo-theme-techdoc">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">
<nav>
<ul>
<li class=""><a href="/">Home</a></li>

<li class=""><a href="/intro/">Getting Started</a>
<ul class="">
<li class=""><a href="/intro/overview/">Brigade Overview</a></li>
<li class=""><a href="/intro/install/">Installing Brigade</a></li>
<li class=""><a href="/intro/tutorial01/">Tutorial 1: Writing a CI pipeline</a></li>
<li class=""><a href="/intro/tutorial02/">Tutorial 2: Setup GitHub</a></li>
<li class=""><a href="/intro/tutorial03/">Tutorial 3: Projects &amp; Events</a></li>
<li class=""><a href="/intro/tutorial04/">Tutorial 4: Writing and Testing an App</a></li>
<li class=""><a href="/intro/writing-efficient-pipelines/">Tutorial 5: Writing Efficient Pipelines</a></li>
</ul>
  
</li>

<li class="parent"><a href="/topics/">Topic Guides</a>
<ul class="sub-menu">
<li class=""><a href="/topics/scripting_advanced/">Advanced Scripting Guide</a></li>
<li class=""><a href="/topics/dockerhub/">Container Registry Integration</a></li>
<li class=""><a href="/topics/dependencies/">Dependencies</a></li>
<li class=""><a href="/topics/design/">Design</a></li>
<li class=""><a href="/topics/developers/">Developer Guide</a></li>
<li class=""><a href="/topics/gateways/">Gateways</a></li>
<li class=""><a href="/topics/genericgateway/">Generic Gateway</a></li>
<li class=""><a href="/topics/github/">GitHub Integration</a></li>
<li class=""><a href="/topics/ingress/">Ingress</a></li>
<li class=""><a href="/topics/projects/">Managing Projects in Brigade</a></li>
<li class=""><a href="/topics/releasing/">Releasing Brigade</a></li>
<li class=""><a href="/topics/scripting/">Scripting Guide</a></li>
<li class="active"><a href="/topics/secrets/">Secret Management</a></li>
<li class=""><a href="/topics/security/">Securing Brigade</a></li>
<li class=""><a href="/topics/storage/">Storage</a></li>
<li class=""><a href="/topics/testing/">Testing</a></li>
<li class=""><a href="/topics/javascript/">The Brigade.js API</a></li>
<li class=""><a href="/topics/readnext/">What to Read Next</a></li>
<li class=""><a href="/topics/workers/">Workers</a></li>
</ul>
  
</li>
</ul>
</nav>


<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>
