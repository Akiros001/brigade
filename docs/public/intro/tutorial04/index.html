<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Tutorial 4: Writing and Testing an App - Brigade</title>
<meta name="description" content="Writing your first CI pipeline, Part 4">
<meta name="generator" content="Hugo 0.54.0" />
<link href="/index.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="/intro/tutorial04/">
<link rel="stylesheet" href="/css/theme.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="/js/functions.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<script src="/js/jquery.backtothetop/jquery.backtothetop.min.js"></script></head>
<body>
<div class="container"><header>
<h1>Brigade</h1>

<p class="description">Brigade - Event-driven scripting for Kubernetes.</p>

</header>

<div class="content-container">
<main><h1>Tutorial 4: Writing and Testing an App</h1>

<h1 id="writing-your-first-ci-pipeline-part-4">Writing your first CI pipeline, Part 4</h1>

<p>This tutorial begins where <a href="tutorial03.md">Tutorial 3</a> left off. We’ll walk through the process for writing your first feature for our UUID generator app, then test the feature on Github using Brigade.</p>

<h2 id="test-the-application">Test the application</h2>

<p>Let’s check that the application shows a UUID if we access the root of the application (/). Let&rsquo;s create a test directory to write our tests:</p>

<pre><code>$ mkdir tests/
$ touch tests/__init__.py
</code></pre>

<p>In order to test the application, open <code>tests/app_tests.py</code> and create a unittest skeleton there:</p>

<pre><code class="language-python">import unittest
import uuid

import app

# Helper

def bytes_to_str(b):
    return ''.join(chr(x) for x in (b))

class AppTestCase(unittest.TestCase):

    def setUp(self):
        self.client = app.app.test_client()


    def test_uuid_generated(self):
        resp = self.client.get('/')
        assert uuid.UUID(bytes_to_str(resp.data))
</code></pre>

<p>Now we can run the test using a minimal basic setup script using setuptools, a built-in Python package that allows developers to more easily build and distribute Python packages.</p>

<p>Open <code>setup.py</code> and write this python code in there:</p>

<pre><code class="language-python">from setuptools import setup, find_packages

setup(
    name=&quot;uuid-generator&quot;,
    version=&quot;0.1&quot;,
    packages=find_packages(),
    test_suite=&quot;tests&quot;,
)
</code></pre>

<p>This tells python to run the tests found in the tests/ directory we created earlier.</p>

<p>To run the tests, invoke</p>

<pre><code>$ python setup.py test
running test
running egg_info
writing uuid_generator.egg-info/PKG-INFO
writing top-level names to uuid_generator.egg-info/top_level.txt
writing dependency_links to uuid_generator.egg-info/dependency_links.txt
reading manifest file 'uuid_generator.egg-info/SOURCES.txt'
writing manifest file 'uuid_generator.egg-info/SOURCES.txt'
running build_ext
test_uuid_generated (tests.app_tests.AppTestCase) ... ok

----------------------------------------------------------------------
Ran 1 test in 0.010s

OK
</code></pre>

<p>Now is a good time to commit your work.</p>

<pre><code>$ git add tests/ setup.py
$ git commit -m &quot;add unit tests&quot;
$ git push origin master
</code></pre>

<h2 id="create-a-brigade-js-file">Create a brigade.js file</h2>

<p>Now that we have successfully written tests for our app and configured a Brigade project, it&rsquo;s time to make use of them.</p>

<p>An <code>brigade.js</code> file must be placed in the root of your git repo and committed.</p>

<p>Brigade uses simple JavaScript files to run tasks. When it comes to task running, Brigade follows this process:</p>

<ul>
<li>Listen for an event</li>
<li>When the event is fired, execute the event handler (if found) in <code>brigade.js</code></li>
<li>Wait until the event is handled, then report the result</li>
</ul>

<p>Given this, the role of the <code>brigade.js</code> file is to declare event handlers. And it&rsquo;s easy. Open <code>brigade.js</code> and write this JavaScript code into it:</p>

<pre><code class="language-javascript">const { events } = require(&quot;brigadier&quot;);

events.on(&quot;push&quot;, function(e, project) {
  console.log(&quot;received push for commit &quot; + e.revision.commit)
})
</code></pre>

<p>The above defines one event: <code>push</code>. This event responds to Github <code>push</code> requests (like <code>git push origin master</code>). If you have configured your Github webhook system correctly (see <a href="tutorial03.md">part 3</a>) then each time GitHub receives a push, it will notify Brigade.</p>

<p>Brigade will run the <code>events.push</code> event handler, and it will give that event handler a single parameter (<code>e</code>), which is a record of the event that was just triggered.</p>

<p>In our script above, we just log the comment:</p>

<pre><code>received push for commit e459558...
</code></pre>

<p>Note that <code>e.revision.commit</code> holds the git commit SHA for the commit that was just pushed.</p>

<h1 id="add-a-job">Add a job</h1>

<p>Logging a commit SHA isn&rsquo;t all that helpful. Instead, we would want to test that our UUID generator project is actually generating UUIDs, wouldn&rsquo;t we?</p>

<p>Edit <code>brigade.js</code> again so it looks like this:</p>

<pre><code class="language-javascript">const { events, Job } = require(&quot;brigadier&quot;);

events.on(&quot;push&quot;, function(e, project) {
  console.log(&quot;received push for commit &quot; + e.revision.commit)

  // Create a new job
  var testRunner = new Job(&quot;test-runner&quot;)

  // We want our job to run the stock Docker Python 3 image
  testRunner.image = &quot;python:3&quot;

  // Now we want it to run these commands in order:
  testRunner.tasks = [
    &quot;cd /src/app&quot;,
    &quot;pip install -r requirements.txt&quot;,
    &quot;cd /src/&quot;,
    &quot;python setup.py test&quot;
  ]

  // Display logs from the job Pod
  testRunner.streamLogs = true;

  // We're done configuring, so we run the job
  testRunner.run()
})
</code></pre>

<p>The example above introduces Brigade jobs. A Job is a particular build step. Each job can run a Docker container and feed it multiple commands.</p>

<p>Above, we create the <code>test-runner</code> job, have it use the <a href="https://hub.docker.com/_/python/">python:3</a> image, and then set it up to run the following commands in that container:</p>

<ul>
<li><code>cd /src/</code>: change into the directory that contains the source code</li>
<li><code>pip install -r requirements.txt</code>: Use pip to install Flask like we did in <a href="tutorial01.md">part 1</a>.</li>
<li><code>python setup.py test</code>: Run the test suite for our project.</li>
</ul>

<p>Finally, when we run <code>testRunner.run()</code>, the job is built and executed. If it passes, all is good. If it fails, Brigade and Github are notified.</p>

<h2 id="wrapping-our-job-in-github-checks">Wrapping our Job in GitHub Checks</h2>

<p>To notify GitHub of our test results utilizing the <a href="https://developer.github.com/v3/checks/">Checks API</a>,
we&rsquo;ll need to add a bit more to our <code>brigade.js</code> file.</p>

<pre><code class="language-javascript">const { events, Job } = require(&quot;brigadier&quot;);

// GitHub Check events to watch for
//
// Note that a GitHub App will automatically generate these events
// from a `push` event, so we don't need an explicit push event handler any longer
events.on(&quot;check_suite:requested&quot;, checkRequested);
events.on(&quot;check_suite:rerequested&quot;, checkRequested);
events.on(&quot;check_run:rerequested&quot;, checkRequested);

// Our main test logic, refactored into a function that returns the job
function runTests(e, project) {
  // Create a new job
  var testRunner = new Job(&quot;test-runner&quot;);

  // We want our job to run the stock Docker Python 3 image
  testRunner.image = &quot;python:3&quot;;

  // Now we want it to run these commands in order:
  testRunner.tasks = [
    &quot;cd /src&quot;,
    &quot;pip install -r requirements.txt&quot;,
    &quot;python setup.py test&quot;
  ];

  // Display logs from the job Pod
  testRunner.streamLogs = true;

  return testRunner;
}

// This runs our main test job, updating GitHub along the way
function checkRequested(e, p) {
  console.log(&quot;check requested&quot;);

  // This Check Run image handles updating GitHub
  const checkRunImage = &quot;deis/brigade-github-check-run:latest&quot;;

  // Common configuration
  const env = {
    CHECK_PAYLOAD: e.payload,
    CHECK_NAME: &quot;Brigade&quot;,
    CHECK_TITLE: &quot;Run Tests&quot;,
  };

  // For convenience, we'll create three jobs: one for each GitHub Check
  // stage.
  const start = new Job(&quot;start-run&quot;, checkRunImage);
  start.imageForcePull = true;
  start.env = env;
  start.env.CHECK_SUMMARY = &quot;Beginning test run&quot;;

  const end = new Job(&quot;end-run&quot;, checkRunImage);
  end.imageForcePull = true;
  end.env = env;

  // Now we run the jobs in order:
  // - Notify GitHub of start
  // - Run the tests
  // - Notify GitHub of completion
  //
  // On error, we catch the error and notify GitHub of a failure.
  start.run().then(() =&gt; {
    return runTests(e, p).run()
  }).then( (result) =&gt; {
    end.env.CHECK_CONCLUSION = &quot;success&quot;
    end.env.CHECK_SUMMARY = &quot;Build completed&quot;
    end.env.CHECK_TEXT = result.toString()
    return end.run()
  }).catch( (err) =&gt; {
    // In this case, we mark the ending failed.
    end.env.CHECK_CONCLUSION = &quot;failure&quot;
    end.env.CHECK_SUMMARY = &quot;Build failed&quot;
    end.env.CHECK_TEXT = `Error: ${ err }`
    return end.run()
  });
}
</code></pre>

<p>At this point, you should commit your work to a new branch and check that it all works:</p>

<pre><code>$ git checkout -b add-brigade
$ git add .
$ git commit -m &quot;add brigade.js&quot;
$ git push origin add-brigade
</code></pre>

<p>Open up a new pull request on your repository using the branch:
<img src="img/img4.png" style="height: 500px;" /></p>

<p>And we should now see the Checks tab with updates/results from the resulting Check Suite:
<img src="img/img5.png" style="height: 500px;" /></p>

<p>This concludes the basic tutorial. If you are familiar with Brigade and are interested in learning how to refactor brigade.js into a more efficient test pipeline, check out <a href="writing-efficient-pipelines.md">Advanced tutorial: Writing efficient pipelines</a>.</p>

<p>You might also be scratching your head on what to <a href="readnext.md">read next</a>.</p>

<hr />

<p>Prev: <a href="tutorial03.md">Part 3</a> <code>|</code> Next: <a href="readnext.md">Next Steps</a></p>
<div class="edit-meta">Last updated on 1 Jan 0001 / Published on 1 Jan 0001<br></div><nav class="pagination"><a class="nav nav-prev" href="/intro/tutorial03/" title="Tutorial 3: Projects &amp; Events"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - Tutorial 3: Projects &amp; Events</a>
<a class="nav nav-next" href="/intro/writing-efficient-pipelines/" title="Tutorial 5: Writing Efficient Pipelines">Next - Tutorial 5: Writing Efficient Pipelines <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav><footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://themes.gohugo.io/hugo-theme-techdoc/">TechDoc</a>. Designed by <a href="https://github.com/thingsym/hugo-theme-techdoc">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">
<nav>
<ul>
<li class=""><a href="/">Home</a></li>

<li class="parent"><a href="/intro/">Getting Started</a>
<ul class="sub-menu">
<li class=""><a href="/intro/overview/">Brigade Overview</a></li>
<li class=""><a href="/intro/install/">Installing Brigade</a></li>
<li class=""><a href="/intro/tutorial01/">Tutorial 1: Writing a CI pipeline</a></li>
<li class=""><a href="/intro/tutorial02/">Tutorial 2: Setup GitHub</a></li>
<li class=""><a href="/intro/tutorial03/">Tutorial 3: Projects &amp; Events</a></li>
<li class="active"><a href="/intro/tutorial04/">Tutorial 4: Writing and Testing an App</a></li>
<li class=""><a href="/intro/writing-efficient-pipelines/">Tutorial 5: Writing Efficient Pipelines</a></li>
</ul>
  
</li>

<li class=""><a href="/topics/">Topic Guides</a>
<ul class="">
<li class=""><a href="/topics/scripting_advanced/">Advanced Scripting Guide</a></li>
<li class=""><a href="/topics/dockerhub/">Container Registry Integration</a></li>
<li class=""><a href="/topics/dependencies/">Dependencies</a></li>
<li class=""><a href="/topics/design/">Design</a></li>
<li class=""><a href="/topics/developers/">Developer Guide</a></li>
<li class=""><a href="/topics/gateways/">Gateways</a></li>
<li class=""><a href="/topics/genericgateway/">Generic Gateway</a></li>
<li class=""><a href="/topics/github/">GitHub Integration</a></li>
<li class=""><a href="/topics/ingress/">Ingress</a></li>
<li class=""><a href="/topics/projects/">Managing Projects in Brigade</a></li>
<li class=""><a href="/topics/releasing/">Releasing Brigade</a></li>
<li class=""><a href="/topics/scripting/">Scripting Guide</a></li>
<li class=""><a href="/topics/secrets/">Secret Management</a></li>
<li class=""><a href="/topics/security/">Securing Brigade</a></li>
<li class=""><a href="/topics/storage/">Storage</a></li>
<li class=""><a href="/topics/testing/">Testing</a></li>
<li class=""><a href="/topics/javascript/">The Brigade.js API</a></li>
<li class=""><a href="/topics/readnext/">What to Read Next</a></li>
<li class=""><a href="/topics/workers/">Workers</a></li>
</ul>
  
</li>
</ul>
</nav>


<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>
